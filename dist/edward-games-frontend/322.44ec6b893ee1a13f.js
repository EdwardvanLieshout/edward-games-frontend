(()=>{"use strict";var D=function(t){return t[t.GREENGRID=0]="GREENGRID",t[t.WOOD=1]="WOOD",t[t.PLAIN=2]="PLAIN",t[t.BRICKWALL=3]="BRICKWALL",t[t.SKY=4]="SKY",t[t.HILLS=5]="HILLS",t[t.GRASS=6]="GRASS",t[t.TV1=7]="TV1",t[t.TV2=8]="TV2",t[t.TV3=9]="TV3",t[t.TV4=10]="TV4",t[t.TV1S=11]="TV1S",t[t.TV2S=12]="TV2S",t[t.TV3S=13]="TV3S",t[t.TV4S=14]="TV4S",t[t.PORTAL1=15]="PORTAL1",t[t.PORTAL2=16]="PORTAL2",t[t.PORTAL3=17]="PORTAL3",t[t.PORTAL4=18]="PORTAL4",t[t.GRIDINFO=19]="GRIDINFO",t[t.HITECH=20]="HITECH",t[t.DISCORED1=21]="DISCORED1",t[t.DISCORED2=22]="DISCORED2",t[t.DISCORED3=23]="DISCORED3",t[t.DISCORED4=24]="DISCORED4",t[t.DISCOBLUE1=25]="DISCOBLUE1",t[t.DISCOBLUE2=26]="DISCOBLUE2",t[t.DISCOBLUE3=27]="DISCOBLUE3",t[t.DISCOBLUE4=28]="DISCOBLUE4",t[t.DISCOMULTI1=29]="DISCOMULTI1",t[t.DISCOMULTI2=30]="DISCOMULTI2",t[t.DISCOMULTI3=31]="DISCOMULTI3",t[t.DISCOMULTI4=32]="DISCOMULTI4",t[t.DISCOGREEN1=33]="DISCOGREEN1",t[t.DISCOGREEN2=34]="DISCOGREEN2",t[t.DISCOGREEN3=35]="DISCOGREEN3",t[t.DISCOGREEN4=36]="DISCOGREEN4",t[t.DISCOPURPLE1=37]="DISCOPURPLE1",t[t.DISCOPURPLE2=38]="DISCOPURPLE2",t[t.DISCOPURPLE3=39]="DISCOPURPLE3",t[t.DISCOPURPLE4=40]="DISCOPURPLE4",t[t.STONEWALL=41]="STONEWALL",t}(D||{}),z=function(t){return t[t.FLOOR=0]="FLOOR",t[t.WALL=1]="WALL",t}(z||{});addEventListener("message",({data:t})=>{const q=t.dirX,r=t.dirY,Z=t.planeX,j=t.planeY,A=t.posX,N=t.posY,G=t.map,M=t.screen_width,o=t.screen_height,V=t.texture_width,b=t.texture_height,O=t.textures,S=t.imageData,p=t.animationCounter,x=t.slowAnimationCounter,m=t.timestamp,J=q-Z,Q=r-j,y=q+Z,T=r+j,e=.5*o;let L,H;L=D.PLAIN,H=D.PLAIN;let _,n,g=Math.trunc(A),X=Math.trunc(N);for(let C=0;C<o;C++){const I=e/(C-o/2),R=I*(y-J)/M,W=I*(T-Q)/M;let Y=A+I*J,P=N+I*Q;for(let f=0;f<M;f++){const l=Math.trunc(Y),h=Math.trunc(P);G[l]&&G[l][h]&&void 0!==G[l][h].tex1&&(L=G[l][h].tex0,H=G[l][h].tex1),(L===D.DISCORED1||L===D.DISCOBLUE1||L===D.DISCOMULTI1||L===D.DISCOGREEN1||L===D.DISCOPURPLE1)&&(L+=Math.floor(x/4));const U=Math.trunc(V*(Y-l))&V-1,i=Math.trunc(b*(P-h))&b-1;Y+=R,P+=W;const c=4*(V*i+U);let a={r:O[L].data[c],g:O[L].data[c+1],b:O[L].data[c+2],a:O[L].data[c+3]};a.r=a.r/I,a.g=a.g/I,a.b=a.b/I;let s=4*(C*M+f);S.data[s]=a.r,S.data[s+1]=a.g,S.data[s+2]=a.b,S.data[s+3]=a.a,a={r:O[H].data[c],g:O[H].data[c+1],b:O[H].data[c+2],a:O[H].data[c+3]},a.r=a.r/I,a.g=a.g/I,a.b=a.b/I,s=4*((o-C-1)*M+f),S.data[s]=a.r,S.data[s+1]=a.g,S.data[s+2]=a.b,S.data[s+3]=a.a}}for(let C=0;C<M;C++){const F=2*C/M-1,I=q+Z*F,R=r+j*F;g=Math.trunc(A),X=Math.trunc(N);const W=Math.sqrt(1+R*R/(I*I)),Y=Math.sqrt(1+I*I/(R*R));let P,f,l,h=!1,U=!1;for(I<0?(f=-1,_=(A-g)*W):(f=1,_=(g+1-A)*W),R<0?(l=-1,n=(N-X)*Y):(l=1,n=(X+1-N)*Y);!h;)_<n?(_+=W,g+=f,U=!1):(n+=Y,X+=l,U=!0),G[g][X].tileType===z.WALL&&(h=!0);P=U?(X-N+(1-l)/2)/R:(g-A+(1-f)/2)/I;const i=Math.trunc(o/P)+10;let c=Math.trunc(-i/2+o/2);c<0&&(c=0);let a=Math.trunc(i/2+o/2);a>o&&(a=o);let B,s=G[g][X].tex0;(s===D.TV1||s===D.TV1S||s===D.PORTAL1)&&(s+=p),s===D.GRIDINFO&&U&&(s=D.GREENGRID),B=U?A+P*I:N+P*R,B-=Math.trunc(B);let w=Math.trunc(B*V);!U&&I>0&&(w=V-w-1),U&&R<0&&(w=V-w-1);const $=1*b/i;let E=(c-o/2+i/2)*$;for(let k=c;k<a;k++){const u=Math.trunc(E)&b-1;E+=$;const K=4*(b*u+w),d={r:O[s].data[K],g:O[s].data[K+1],b:O[s].data[K+2],a:O[s].data[K+3]};d.r=d.r*(i>o?o:i)/o,d.g=d.g*(i>o?o:i)/o,d.b=d.b*(i>o?o:i)/o;const v=4*(k*M+C);S.data[v]=d.r,S.data[v+1]=d.g,S.data[v+2]=d.b,S.data[v+3]=d.a}}postMessage({imageData:S,timestamp:m})})})();